<% @page_heading_title = "Order" %>
<% content_for :page_heading_button do %>
  <%= render partial: "/layouts/stacked_shell/headings/buttons/animated_edit", locals: {
    link_to_path: edit_order_path(@order),
    link_to_text: "Edit order",
  } if authorized_internal_user? %>
  <% if !authorized_internal_user? %>
    <%= render partial: "/layouts/stacked_shell/headings/buttons/back_btn_with_fallback", locals: {
      fallback_location: dashboard_path,
      fallback_location_text: "Dashboard",
    } %>
  <% end %>
<% end %>
<% content_for :page_heading_card do %>
  <%= turbo_stream.update "card_title", "Order #{@order.id}" %>

  <%= turbo_stream.update "card_content" do %>
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-2">
      <%= render partial: "/application/data_display/stats/overview_card", locals: {
        card_title: "Ship",
        card_description: @order.purchaser.name,
        card_link: (link_to "View Ship", purchaser_orders_path(@order.purchaser), class:"font-medium text-cyan-700 hover:text-cyan-900"),
        card_icon: (render partial: "/layouts/stacked_shell/headings/icons/purchaser"),
      } %>
      <% vendor_data_overview_card_link = (link_to "View Vendor", vendor_orders_path(@order.vendor), class:"font-medium text-cyan-700 hover:text-cyan-900") if authorized_internal_user?  %>
      <% vendor_data_overview_card_link = content_tag(:p, "Vendor", class:"font-medium hover:cursor-default") if !authorized_internal_user? %>
      <%= render partial: "/application/data_display/stats/overview_card", locals: {
        card_title: "Vendor",
        card_description: @order.vendor.name,
        # card_link: (link_to "View Vendor", vendor_orders_path(@order.vendor), class:"font-medium text-cyan-700 hover:text-cyan-900"),
        card_link: vendor_data_overview_card_link,
        card_icon: (render partial: "/layouts/stacked_shell/headings/icons/vendor"),
      } %>
    </div>
  <% end %>
<% end %>
<span id="<%= dom_id @order %>">
  <!-- <section class="pb-12">
    <div class="sm:flex sm:items-center mb-5 sm:mb-7">
      <div class="sm:flex-auto">
        <div class="text-center sm:text-left">
          <%#= tag.h1 'Order Content', class: %w( ml-2 text-2xl font-semibold leading-6 text-gray-900 ) %>
          <%#= tag.p 'Information about what was recieved in the order.', class: %w( mt-2 ml-2 mb-1 text-md text-gray-700 ) %>
        </div>
      </div>
    </div>
    <div class="overflow-hidden bg-white rounded-md border border-gray-100 shadow">
      <div class="px-4 py-5 sm:px-6">
        <%#= tag.p 'Order content' %>
        <%# if (!@order_content.nil? && !(@order_content.new_record?)) %>
          <%#= turbo_frame_tag "order_content_#{@order_content.id}", src: order_content_path(@order_content) do %>
            <%#= tag.p 'Loading order content...' %>
          <%# end %>
        <%# end %>
      </div>
    </div>
  </section> -->
  <div class="mb-6">
    <section>
      <header class="sm:flex sm:items-center mb-5 sm:mb-7">
        <div class="sm:flex-auto">
          <div class="text-center sm:text-left">
            <h1 class="ml-2 text-2xl font-semibold leading-6 text-gray-900">
              Order content
            </h1>
            <%= tag.p 'Information about what was recieved in the order.', class: %w( mt-2 ml-2 mb-1 text-md text-gray-700 ) %>
          </div>
        </div>
        <div class="text-center sm:text-right mt-4 sm:mt-0 sm:ml-16 sm:flex-none hover:cursor-pointer">
          <%= render partial: 'statuses/status', locals:{ statusable: @order } %>
        </div>
      </header>
      <article class="">
        <dl class="mt-5 grid grid-cols-1 gap-5 sm:grid-cols-3">
          <div class="overflow-hidden text-center sm:text-left rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <%= tag.dt 'Boxes', class: %w( truncate text-sm font-medium text-gray-500 ) %>
            <%= tag.dd @order_content.packaging_materials.boxes.size, class: %w( mt-1 text-3xl font-semibold tracking-tight text-gray-9000 ) %>
          </div>
          <div class="overflow-hidden text-center sm:text-left rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <%= tag.dt 'Crates', class: %w( truncate text-sm font-medium text-gray-500 ) %>
            <%= tag.dd @order_content.packaging_materials.crates.size, class: %w( mt-1 text-3xl font-semibold tracking-tight text-gray-9000 ) %>
          </div>
          <div class="overflow-hidden text-center sm:text-left rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <%= tag.dt 'Pallets', class: %w( truncate text-sm font-medium text-gray-500 ) %>
            <%= tag.dd @order_content.packaging_materials.pallets.size, class: %w( mt-1 text-3xl font-semibold tracking-tight text-gray-9000 ) %>
          </div>
          <% if @order_content.packaging_materials.others.any? %>
            <div class="overflow-hidden text-center sm:text-left rounded-lg bg-white px-4 py-5 shadow sm:p-6">
              <%= tag.dt 'Others', class: %w( truncate text-sm font-medium text-gray-500 ) %>
              <%= tag.dd @order_content.packaging_materials.others.size, class: %w( mt-1 text-3xl font-semibold tracking-tight text-gray-9000 ) %>
            </div>
          <% end %>
        </dl>
      </article>
    </section>
  </div>
  <span>
    <section class="pb-12">
      <div class="overflow-hidden bg-white rounded-md border border-gray-100 shadow">
        <div class="bg-white rounded-lg">
          <div class="py-6 flex flex-wrap sm:flex-nowrap justify-center sm:justify-between sm:grid-rows-1 border-b">
            <div class="mt-1 text-center block w-full sm:inline-flex sm:w-auto sm:mx-3 text-lg font-semibold leading-6 text-gray-900">
              Packaging Materials
            </div>
            <div class="block sm:inline-flex sm:w-auto mx-3 sm:justify-self-end mt-3 sm:mt-0">
              <%#= button_to(
                "Edit packaging materials",
                edit_order_content_path(@order_content),
                method: :get,
                class:"w-full btn rounded-md bg-white py-2.5 px-3.5 text-sm font-medium text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50"
              ) if authorized_internal_user? %>

              <!-- <%# if authorized_internal_user? %>
                <div class="mr-3">
                  <div data-controller="visibility" data-visibility-value-toggled="false" class="inline-flex rounded-md shadow-sm">
                    <button type="button" data-action="visibility#toggleTargets" class="relative inline-flex items-center rounded-l-md bg-white px-3 py-2 text-sm font-normal text-gray-600 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10">Add new packaging material</button>
                    <div class="relative -ml-px block">
                      <button type="button"  data-action="visibility#toggleTargets" class="relative inline-flex items-center rounded-r-md bg-white px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-10" id="option-menu-button" aria-expanded="true" aria-haspopup="true">
                        <span class="sr-only">Open options</span>
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                          <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                      </button>
                      <div data-visibility-target="hideable" hidden class="absolute right-0 z-10 -mr-1 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="option-menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                          <%# dropdown_css = 'text-gray-700 hover:text-gray-900 hover:bg-gray-100 block px-4 py-2 text-sm' %>
                          <%#= link_to 'New box', new_order_content_packaging_material_box_path(@order_content), class: dropdown_css %>
                          <%#= link_to 'New crate', new_order_content_packaging_material_crate_path(@order_content), class: dropdown_css %>
                          <%#= link_to 'New pallet', new_order_content_packaging_material_pallet_path(@order_content), class: dropdown_css %>
                          <%#= link_to 'New other', new_order_content_packaging_material_path(@order_content), class: dropdown_css %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <%# end %> -->
            </div>
          </div>
          <div class="mx-4 sm:mx-6 pb-9">
          <%= turbo_frame_tag "packaging_materials", src: order_content_packaging_materials_path(@order_content) do %>
            <%= tag.p 'Loading packaging materials...' %>
          <% end %>
          </div>
        </div>
      </div>
    </section>
  </span>
  <!-- <section class="pb-12" aria-labelledby="order-content-packaging-materials">
    <div class="pt-5 pb-3 px-4 sm:px-0">
      <%#= turbo_frame_tag "packaging_materials", src: order_content_packaging_materials_path(@order_content) do %>
        <%#= tag.p 'Loading packaging materials...' %>
      <%# end %>
    </div>
  </section> -->
  <section class="pb-12" aria-labelledby="order-details-more">
    <div class="bg-white shadow rounded-lg">
      <div class="px-4 pt-5 pb-3 sm:px-6">
        <h2 class="mb-2 text-xl font-medium leading-6 text-gray-900">More details</h2>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">More information about order.</p>
      </div>
      <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
        <dl class="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2">
          <div class="sm:col-span-1 p-1 sm:-m-1 rounded-md hover:bg-gray-100">
            <div class="cursor-default">
              <div class="text-sm font-medium text-gray-500">
                Order Sequence
              </div>
              <div class="text-sm text-gray-900">
                <%= render "inline_edit", model: @order, attribute: :order_sequence do %>
                  <%= @order.order_sequence %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="sm:col-span-1 p-1 sm:-m-1 rounded-md hover:bg-gray-100">
            <div class="cursor-default">
              <div class="text-sm font-medium text-gray-500">
                PO/Tracking Number
              </div>
              <div class="text-sm text-gray-900">
                <%= render "inline_edit", model: @order, attribute: :po_number do %>
                  <%= @order.po_number %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="sm:col-span-1 p-1 sm:-m-1 rounded-md hover:bg-gray-100">
            <div class="cursor-default">
              <div class="text-sm font-medium text-gray-500">
                Date Recieved
              </div>
              <div class="text-sm text-gray-900">
                <%= render "inline_edit", model: @order, attribute: :date_recieved do %>
                  <%= @order.try(:date_recieved) ? @order.date_recieved.try(:strftime,"%m/%d/%Y") : 'n/a' %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="sm:col-span-1 p-1 sm:-m-1 rounded-md hover:bg-gray-100">
            <div class="cursor-default">
              <div class="text-sm font-medium text-gray-500">
                Date Delivered
              </div>
              <div class="text-sm text-gray-900">
                <%= render "inline_edit", model: @order, attribute: :date_delivered do %>
                  <%= @order.try(:date_delivered) ? @order.date_delivered.try(:strftime,"%m/%d/%Y") : 'n/a' %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="sm:col-span-1 p-1 sm:-m-1 rounded-md hover:bg-gray-100">
            <div class="cursor-default">
              <div class="text-sm font-medium text-gray-500">
                Courrier
              </div>
              <div class="text-sm text-gray-900">
                <%= render "inline_edit", model: @order, attribute: :courrier do %>
                  <%= @order.courrier %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="sm:col-span-1 p-1 sm:-m-1 rounded-md hover:bg-gray-100">
            <div class="cursor-default">
              <div class="text-sm font-medium text-gray-500">
                Dept
              </div>
              <div class="text-sm text-gray-900">
                <%= render "orders/inline_edit_dept", order: @order, attribute: :dept do %>
                  <%= content_tag(:div, @order.dept, class: "text-sm text-gray-900") %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="sm:col-span-2">
            <dt class="text-sm font-medium text-gray-500">
              <span id="<%= "attachment_count" %>">
                <%= pluralize(@order.images.count, 'Attachment') %>
              </span>
            </dt>
            <dd class="mt-1 text-sm text-gray-900 sm:col-span-2 sm:mt-0">
              <% if @order.images.count > 0 %>
                <ul role="list" class="divide-y divide-gray-200 rounded-md border border-gray-200">
                  <% upload_count = 1 %>
                  <% @order.images.reverse.each do |image| %>
                    <span id="<%= "attachment_#{image.signed_id}" %>">
                      <% if !image.variable?  %>
                        <li data-controller="reveal" data-reveal-hidden-class="hidden">
                          <div class="flex items-center justify-between py-3 pl-3 pr-4 text-sm bg-red-100">
                            <div class="flex w-0 flex-1 items-center">
                              <svg class="h-5 w-5 flex-shrink-0 text-red-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M15.621 4.379a3 3 0 00-4.242 0l-7 7a3 3 0 004.241 4.243h.001l.497-.5a.75.75 0 011.064 1.057l-.498.501-.002.002a4.5 4.5 0 01-6.364-6.364l7-7a4.5 4.5 0 016.368 6.36l-3.455 3.553A2.625 2.625 0 119.52 9.52l3.45-3.451a.75.75 0 111.061 1.06l-3.45 3.451a1.125 1.125 0 001.587 1.595l3.454-3.553a3 3 0 000-4.242z" clip-rule="evenodd" />
                              </svg>
                              <span class="ml-2 w-0 flex-1 text-red-600 truncate"> <%= "ERROR: INCORRECT FILE TYPE #{image.blob.filename}" %> </span>
                            </div>
                            <div class="ml-4 flex-shrink">
                              <%= link_to "Download", rails_blob_path(image, disposition: :attachment), class:" mx-2 font-medium text-indigo-600 hover:text-indigo-500" %>
                              <div class="inline-block">
                                <%= button_to "Delete", {
                                    action: "destroy_attachment",
                                    signed_id: image.signed_id
                                  },
                                  method: :delete,
                                  data: {
                                    turbo_confirm: "Are you sure you want to delete this attachment? Once deleted it cannot be recovered."
                                  },
                                  class: "font-medium text-red-600 hover:text-red-700" if current_user.has_role?('admin') || current_user.has_role?('staff') %>
                              </div>
                            </div>
                          </div>
                        </li>
                      <% end %>
                      <% if image.variable? %>
                        <li data-controller="reveal" data-reveal-hidden-class="hidden">
                          <div class="flex items-center justify-between py-3 pl-3 pr-4 text-sm">
                            <div class="flex w-0 flex-1 items-center">
                              <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M15.621 4.379a3 3 0 00-4.242 0l-7 7a3 3 0 004.241 4.243h.001l.497-.5a.75.75 0 011.064 1.057l-.498.501-.002.002a4.5 4.5 0 01-6.364-6.364l7-7a4.5 4.5 0 016.368 6.36l-3.455 3.553A2.625 2.625 0 119.52 9.52l3.45-3.451a.75.75 0 111.061 1.06l-3.45 3.451a1.125 1.125 0 001.587 1.595l3.454-3.553a3 3 0 000-4.242z" clip-rule="evenodd" />
                              </svg>
                              <span class="ml-2 w-0 flex-1 truncate"> <%= image.blob.filename %> </span>
                            </div>
                            <div class="ml-4 flex-shrink-0">
                              <button data-action="click->reveal#toggle" type="button" class="mx-2">
                                Preview
                              </button>
                              <%= link_to "Download", rails_blob_path(image, disposition: :attachment), class:"mx-2 font-medium text-indigo-600 hover:text-indigo-500" if image.variable? %>
                              <div class="inline-block">
                                <%= button_to "Delete", {
                                    action: "destroy_attachment",
                                    signed_id: image.signed_id
                                  },
                                  method: :delete,
                                  data: {
                                    turbo_confirm: "Are you sure you want to delete this attachment? Once deleted it cannot be recovered."
                                  },
                                  class: "font-medium text-red-600 hover:text-red-700" if current_user.has_role?('admin') || current_user.has_role?('staff') %>
                              </div>
                            </div>
                          </div>
                          <div data-reveal-target="item" class="hidden">
                            <div class="grid justify-items-center bg-gray-100 p-5">
                              <span class="text-center text-md sm:text-xl flex-shrink">Preview: <%= image.blob.filename %> </span>
                              <%= image_tag image, class:"object-fit" %>
                            </div>
                          </div>
                        </li>
                      <% end %>
                    </span>
                    <% upload_count += 1 %>
                  <% end %>
                </ul>
              <% end %>
            </dd>
          </div>
        </dl>
      </div>
      <!-- <div data-controller="reveal" data-reveal-hidden-class="hidden">
        <button data-action="click->reveal#toggle" type="button" class="block bg-gray-100 w-full py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700 sm:rounded-b-lg">
          Upload Attachment - placeholder
        </button>
        <div data-reveal-target="item" class="hidden py-3 px-6">
          <div class="p-3 w-full rounded-md border-2 border-dashed border-gray-300 px-6 pt-5 pb-6">
            <div class="flex justify-center ">
              <div class="space-y-1 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                  <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <div class="flex text-sm text-gray-600">
                  <label for="file-upload" class="relative cursor-pointer rounded-md bg-white font-medium text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2 hover:text-indigo-500">
                    <span>Click here to upload an attachment</span>
                    <input id="file-upload" name="file-upload" type="file" class="sr-only">
                  </label>
                </div>
                <p class="text-xs text-gray-500">Accepts PNG, JPG, MP3</p>
              </div>
            </div>
          </div>
          <div class="mt-3 flex justify-center">
            <div class="text-center">
              <button type="button" class="rounded-md bg-white py-2.5 px-3.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Save - placeholder</button>
            </div>
          </div>
        </div>
      </div> -->
    </div>
  </section>
  <!-- <div>
    <div class="overflow-hidden bg-white shadow rounded-lg">
      <div class="px-4 py-5 sm:px-6">
        <div class="flex flex-wrap justify-around sm:justify-between">
          <div class=" sm:mx-0">
            Previous Order
          </div>
          <div class=" sm:mx-0">
            Next Order
          </div>
        </div>
      </div>
    </div>
  </div> -->
</span>
